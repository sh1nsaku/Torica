<!DOCTYPE html><html lang="ja"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ToriCa ゲスト</title>
<style>
:root{--bg:#f5f7fb;--muted:#6b7280;--accent:#2563eb}
*{box-sizing:border-box}body{margin:0;background:var(--bg);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",Meiryo,sans-serif;display:flex;min-height:100vh;align-items:center;justify-content:center;padding:20px;color:#111}
.card{width:100%;max-width:460px;background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:22px}
h1{margin:0 0 12px;font-size:20px}
.row{display:grid;grid-template-columns:110px 1fr;gap:10px;font-size:15px;margin:10px 0}
.key{color:var(--muted)}
.desc{color:var(--muted);font-size:13px;line-height:1.5;margin:10px 0 16px}
.btn{width:100%;padding:12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;cursor:pointer;font:inherit}
.primary{background:var(--accent);color:#fff;border-color:transparent}
.small{font-size:12px;color:var(--muted);margin-top:8px}
</style>
</head><body>
<main class="card" role="main" aria-live="polite">
  <h1>ゲストページ</h1>

  <div class="row"><div class="key">学校名</div><div id="school">—</div></div>
  <div class="row"><div class="key">名前</div><div id="sname">—</div></div>
  <div class="row"><div class="key">緊急電話</div><div id="tel">—</div></div>

  <p class="desc">
    「位置情報送信」は、迷子やトラブルの早期発見のために、先生へ現在地を共有するためのボタンです。<br>
    状況が落ち着いたら近くの先生の指示に従ってください。
  </p>

  <button id="sendLoc" class="btn primary">位置情報を送信する（先生へ）</button>
  <p class="small">※送信後はお礼ページに移動します。</p>
</main>

<script src="./app.js"></script>
<script>
(function(){
  const P = new URL(location.href).searchParams;
  const cardId = P.get("card")||"";
  const place  = P.get("place") || "NFCタッチ";

  // 表示
  document.getElementById("school").textContent = ToriCa.SCHOOL_INFO.name;
  document.getElementById("tel").textContent    = ToriCa.SCHOOL_INFO.emergencyTel;

  // 生徒名を台帳から取得
  const students = JSON.parse(localStorage.getItem(ToriCa.K.STUDENTS)||"{}");
  const stu = students[cardId];
  document.getElementById("sname").textContent = (stu && stu.name) ? stu.name : "(未登録)";

  // セッショントークン（通過ログの重複記録防止用。表示はしない）
  let token = P.get("t");
  if (!token){
    token = ToriCa.createGuestToken({cardId, place});
    const u = new URL(location.href); u.searchParams.set("t", token);
    history.replaceState({}, "", u);
  }
  const state = ToriCa.readGuestToken(token);
  if (state.ok && !state.info.wrote){
    // 初回アクセス時のみ、教員側で見える「通過ログ」を自動記録
    ToriCa.recordPassage({cardId, place, source:"guest"});
    ToriCa.markGuestTokenWrote(token);
  }

  // 位置情報送信 → 緊急通知 → お礼ページへ遷移
  document.getElementById("sendLoc").onclick = ()=>{
    const goThanks = ()=> location.href = `thanks.html?card=${encodeURIComponent(cardId)}`;
    const send = (lat,lng)=>{ ToriCa.pushEmergency({cardId, lat, lng, place:"位置情報送信"}); goThanks(); };
    if (!navigator.geolocation){ send(null,null); return; }
    navigator.geolocation.getCurrentPosition(
      pos => send(pos.coords.latitude, pos.coords.longitude),
      _err => send(null,null),
      {enableHighAccuracy:true, timeout:8000, maximumAge:0}
    );
  };
})();
</script>
</body></html>
